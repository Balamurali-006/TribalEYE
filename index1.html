<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gram Sabha</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg1:#667eea;
      --bg2:#764ba2;
      --bg3:#f093fb;
    }
    html,body {
      height:100%;
      margin:0;
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 50%, var(--bg3) 100%);
      -webkit-font-smoothing:antialiased;
    }
    .container {
      max-width:800px;
      margin:40px auto;
      background:#fff;
      border-radius:10px;
      padding:30px 40px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.25);
      color:#000;
    }
    h1 {
      margin:0 0 12px 0;
      font-weight:700;
      font-size:28px;
      color:#222;
    }
    p.lead { margin:0 0 20px 0; color:#444; }
    label { 
      display:block; 
      margin:16px 0 6px; 
      font-weight:600; 
      font-size:15px; 
      color:#222; 
    }
    input[type="text"], select {
      width:100%;
      padding:10px 12px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:15px;
      color:#000;
      background:#fff;
      outline:none;
    }
    input[type="file"] {
      width:100%;
      padding:10px;
      border-radius:6px;
      border:1px dashed #999;
      font-size:14px;
      color:#000;
      background:#fafafa;
    }
    small.hint { display:block; margin-top:6px; font-size:13px; color:#666; }
    .actions { display:flex; gap:12px; margin-top:22px; }
    button {
      padding:10px 18px;
      border-radius:6px;
      border:1px solid #444;
      background:#222;
      color:#fff;
      cursor:pointer;
      font-weight:600;
      transition:background 0.2s;
    }
    button:hover { background:#444; }
    .note { margin-top:12px; font-size:13px; color:#333; }
    .result {
      margin-top:18px; 
      padding:12px; 
      border-radius:6px; 
      background:#f7f7f7; 
      font-size:14px; 
      color:#000; 
      max-height:320px; 
      overflow:auto; 
      border:1px solid #ddd;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gram Sabha</h1>
    <p class="lead">Claim submission â€” enter details and upload claim form (PDF). Key-value pairs will be extracted and stored centrally.</p>

    <form id="claimForm">
      <label>Enter name of the Claimant</label>
      <input type="text" id="claimant_name" name="claimant_name" required />

      <label>Enter Gram Sabha ID</label>
      <input type="text" id="gram_sabha_id" name="gram_sabha_id" required />

      <label>Choose your type of claim</label>
      <select id="claim_type" name="claim_type" required>
        <option value="">-- Select claim type --</option>
        <option value="Individual Claim">Individual Claim</option>
        <option value="Community Claim">Community Claim</option>
        <option value="Community Resource Claim">Community Resource Claim</option>
      </select>

      <label>Upload your file (PDF preferred)</label>
      <input type="file" id="claim_file" name="claim_file" accept=".pdf,.txt,.docx" required />
      <small class="hint">Supported: text-based PDFs, .txt, .docx. For scanned PDFs OCR may be needed (server-side tesseract).</small>

      <div class="actions">
        <button type="button" id="uploadBtn">Upload & Extract</button>
        <button type="button" id="previewBtn">Preview last entry</button>
        <button type="button" id="viewDbBtn">View Database</button>
      </div>
    </form>

    <div id="status" class="note"></div>
    <div id="result" class="result" style="display:none;"></div>
  </div>

<script>
async function postForm(actionUrl, formData){
  const res = await fetch(actionUrl, {
    method:'POST',
    body: formData
  });
  return res.json();
}

document.getElementById('uploadBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('claimant_name').value.trim();
  const gid = document.getElementById('gram_sabha_id').value.trim();
  const type = document.getElementById('claim_type').value;
  const file = document.getElementById('claim_file').files[0];
  if(!name || !gid || !type || !file){ alert('Fill all fields and attach a file.'); return; }

  const fd = new FormData();
  fd.append('claimant_name', name);
  fd.append('gram_sabha_id', gid);
  fd.append('claim_type', type);
  fd.append('claim_file', file);

  document.getElementById('status').innerText = 'Uploading and extracting...';
  const json = await postForm('/upload', fd);
  if(json.success){
document.getElementById('status').innerText = 'Upload complete. Parsed key-value pairs appended to central CSV.';
  document.getElementById('result').style.display='block';

  // Build a neat table from parsed_pairs
  let table = "<table border='1' cellpadding='6' cellspacing='0' style='border-collapse:collapse;width:100%;font-size:14px;'>";
  table += "<tr><th style='text-align:left;background:#f0f0f0;'>Field</th><th style='text-align:left;background:#f0f0f0;'>Value</th></tr>";
  for (const [key, value] of Object.entries(json.parsed_pairs)) {
    table += `<tr><td>${key}</td><td>${value}</td></tr>`;
  }
  table += "</table>";

  document.getElementById('result').innerHTML = table;
  } else {
    document.getElementById('status').innerText = 'Error: ' + (json.error || 'Unknown');
    document.getElementById('result').style.display='none';
  }
});

document.getElementById('previewBtn').addEventListener('click', async ()=>{
  const res = await fetch('/last_entry');
  const j = await res.json();
  if(j.success){
    document.getElementById('status').innerText = 'Previewing last CSV row';
    document.getElementById('result').style.display='block';
    document.getElementById('result').innerText = JSON.stringify(j.row, null, 2);
  } else {
    document.getElementById('status').innerText = 'No CSV or error.';
  }

  document.getElementById('viewDbBtn').addEventListener('click', async ()=>{
  const res = await fetch('/view_database');
  const j = await res.json();
  if(j.success){
    document.getElementById('status').innerText = 'Showing entire database (CSV)';
    document.getElementById('result').style.display='block';
    // Pretty table output
    let html = "<table border='1' cellpadding='6' cellspacing='0' style='border-collapse:collapse;width:100%;font-size:14px;'>";
    html += "<tr>" + Object.keys(j.rows[0]).map(k=>`<th>${k}</th>`).join('') + "</tr>";
    j.rows.forEach(row=>{
      html += "<tr>" + Object.values(row).map(v=>`<td>${v}</td>`).join('') + "</tr>";
    });
    html += "</table>";
    document.getElementById('result').innerHTML = html;
  } else {
    document.getElementById('status').innerText = 'Error: ' + (j.error || 'unknown');
  }
});

});
</script>
</body>
</html>
