<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gram Sabha - Claim Submission</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg1:#667eea;
      --bg2:#764ba2;
      --bg3:#f093fb;
    }
    html,body {
      height:100%;
      margin:0;
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 50%, var(--bg3) 100%);
      -webkit-font-smoothing:antialiased;
    }
    .container {
      max-width:800px;
      margin:40px auto;
      background:#fff;
      border-radius:10px;
      padding:30px 40px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.25);
      color:#000;
    }
    h1 {
      margin:0 0 12px 0;
      font-weight:700;
      font-size:28px;
      color:#222;
    }
    p.lead { margin:0 0 20px 0; color:#444; }
    label { 
      display:block; 
      margin:16px 0 6px; 
      font-weight:600; 
      font-size:15px; 
      color:#222; 
    }
    input[type="text"], select {
      width:100%;
      padding:10px 12px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:15px;
      color:#000;
      background:#fff;
      outline:none;
    }
    input[type="file"] {
      width:100%;
      padding:10px;
      border-radius:6px;
      border:1px dashed #999;
      font-size:14px;
      color:#000;
      background:#fafafa;
    }
    small.hint { display:block; margin-top:6px; font-size:13px; color:#666; }
    .actions { display:flex; gap:12px; margin-top:22px; flex-wrap:wrap; }
    button {
      padding:10px 18px;
      border-radius:6px;
      border:1px solid #444;
      background:#222;
      color:#fff;
      cursor:pointer;
      font-weight:600;
      transition:background 0.2s;
    }
    button:hover { background:#444; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    .note { margin-top:12px; font-size:13px; color:#333; padding:10px; background:#f0f0f0; border-radius:6px; }
    .result {
      margin-top:18px; 
      padding:12px; 
      border-radius:6px; 
      background:#f7f7f7; 
      font-size:14px; 
      color:#000; 
      max-height:320px; 
      overflow:auto; 
      border:1px solid #ddd;
    }
    .server-status {
      margin-bottom:20px;
      padding:12px;
      border-radius:6px;
      background:#e7f3ff;
      border-left:4px solid #2196F3;
      font-size:14px;
    }
    .status-online { color:#28a745; font-weight:600; }
    .status-offline { color:#dc3545; font-weight:600; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    table th, table td { border:1px solid #ddd; padding:8px; text-align:left; }
    table th { background:#f0f0f0; font-weight:600; }
  </style>
</head>
<body>
  <div class="container">
    <div class="server-status" id="serverStatus">
    </div>

    <h1>Gram Sabha Claim Submission</h1>
    <p class="lead">Enter details and upload claim form (PDF/TXT/DOCX). Key-value pairs will be extracted and stored centrally.</p>

    <form id="claimForm">
      <label>Enter name of the Claimant *</label>
      <input type="text" id="claimant_name" name="claimant_name" required />

      <label>Enter Gram Sabha ID *</label>
      <input type="text" id="gram_sabha_id" name="gram_sabha_id" required />

      <label>Choose your type of claim *</label>
      <select id="claim_type" name="claim_type" required>
        <option value="">-- Select claim type --</option>
        <option value="Individual Claim">Individual Claim</option>
        <option value="Community Claim">Community Claim</option>
        <option value="Community Resource Claim">Community Resource Claim</option>
      </select>

      <label>Upload your file (PDF preferred) *</label>
      <input type="file" id="claim_file" name="claim_file" accept=".pdf,.txt,.docx" required />
      <small class="hint">Supported: text-based PDFs, .txt, .docx files</small>

      <div class="actions">
        <button type="button" id="uploadBtn">Upload & Extract</button>
        <button type="button" id="previewBtn">Preview Last Entry</button>
        <button type="button" id="viewDbBtn">View Database</button>
      </div>
    </form>

    <div id="status" class="note" style="display:none;"></div>
    <div id="result" class="result" style="display:none;"></div>
  </div>

<script>
// Detect server URL
function getServerUrl() {
  const hostname = window.location.hostname;
  const protocol = window.location.protocol;
  const port = window.location.port;
  
  // If running locally
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    return 'http://127.0.0.1:5000';
  }
  
  // If hosted, assume same domain
  if (port) {
    return `${protocol}//${hostname}:${port}`;
  }
  return `${protocol}//${hostname}`;
}

const SERVER_URL = getServerUrl();

// Check server status on load
async function checkServerStatus() {
  const statusIndicator = document.getElementById('statusIndicator');
  const statusText = document.getElementById('statusText');
  
  try {
    const res = await fetch(`${SERVER_URL}/health`, {
      method: 'GET',
      mode: 'cors'
    });
    const data = await res.json();
    
    if (data.success) {
      statusIndicator.className = 'status-online';
      statusText.textContent = `Server Online (${SERVER_URL})`;
      return true;
    }
  } catch (error) {
    console.error('Server check failed:', error);
  }
  
  statusIndicator.className = 'status-offline';
  return false;
}

// Post form data
async function postForm(actionUrl, formData) {
  const res = await fetch(actionUrl, {
    method: 'POST',
    body: formData,
    mode: 'cors'
  });
  return res.json();
}

// Show message
function showMessage(text, isError = false) {
  const statusDiv = document.getElementById('status');
  statusDiv.style.display = 'block';
  statusDiv.innerText = text;
  statusDiv.style.background = isError ? '#f8d7da' : '#d4edda';
  statusDiv.style.color = isError ? '#721c24' : '#155724';
  statusDiv.style.border = isError ? '1px solid #f5c6cb' : '1px solid #c3e6cb';
}

// Upload button handler
document.getElementById('uploadBtn').addEventListener('click', async () => {
  const name = document.getElementById('claimant_name').value.trim();
  const gid = document.getElementById('gram_sabha_id').value.trim();
  const type = document.getElementById('claim_type').value;
  const file = document.getElementById('claim_file').files[0];
  
  if (!name || !gid || !type || !file) {
    alert('Please fill all required fields and attach a file.');
    return;
  }

  const fd = new FormData();
  fd.append('claimant_name', name);
  fd.append('gram_sabha_id', gid);
  fd.append('claim_type', type);
  fd.append('claim_file', file);

  showMessage('Uploading and extracting...');
  
  try {
    const json = await postForm(`${SERVER_URL}/upload`, fd);
    
    if (json.success) {
      showMessage('Upload complete! Parsed key-value pairs appended to central CSV.');
      document.getElementById('result').style.display = 'block';

      // Build table from parsed_pairs
      let table = "<table><tr><th>Field</th><th>Value</th></tr>";
      for (const [key, value] of Object.entries(json.parsed_pairs)) {
        table += `<tr><td>${escapeHtml(key)}</td><td>${escapeHtml(value)}</td></tr>`;
      }
      table += "</table>";

      document.getElementById('result').innerHTML = table;
      
      // Clear form
      document.getElementById('claimForm').reset();
    } else {
      showMessage('Error: ' + (json.error || 'Unknown error'), true);
      document.getElementById('result').style.display = 'none';
    }
  } catch (error) {
    showMessage('Error: ' + error.message, true);
    document.getElementById('result').style.display = 'none';
  }
});

// Preview button handler
document.getElementById('previewBtn').addEventListener('click', async () => {
  try {
    const res = await fetch(`${SERVER_URL}/last_entry`, {
      method: 'GET',
      mode: 'cors'
    });
    const j = await res.json();
    
    if (j.success) {
      showMessage('Previewing last CSV row');
      document.getElementById('result').style.display = 'block';
      document.getElementById('result').innerHTML = `<pre>${JSON.stringify(j.row, null, 2)}</pre>`;
    } else {
      showMessage('Error: ' + (j.error || 'No data found'), true);
      document.getElementById('result').style.display = 'none';
    }
  } catch (error) {
    showMessage('Error: ' + error.message, true);
  }
});

// View database button handler
document.getElementById('viewDbBtn').addEventListener('click', async () => {
  try {
    const res = await fetch(`${SERVER_URL}/view_database`, {
      method: 'GET',
      mode: 'cors'
    });
    const j = await res.json();
    
    if (j.success && j.rows && j.rows.length > 0) {
      showMessage(`Showing entire database (${j.count} records)`);
      document.getElementById('result').style.display = 'block';
      
      // Build table
      let html = "<table><tr>";
      html += Object.keys(j.rows[0]).map(k => `<th>${escapeHtml(k)}</th>`).join('');
      html += "</tr>";
      
      j.rows.forEach(row => {
        html += "<tr>" + Object.values(row).map(v => `<td>${escapeHtml(String(v))}</td>`).join('') + "</tr>";
      });
      html += "</table>";
      
      document.getElementById('result').innerHTML = html;
    } else {
      showMessage('Error: ' + (j.error || 'No data found'), true);
      document.getElementById('result').style.display = 'none';
    }
  } catch (error) {
    showMessage('Error: ' + error.message, true);
  }
});

// Utility function to escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Check server on load
window.addEventListener('DOMContentLoaded', () => {
  checkServerStatus();
});
</script>
</body>
</html>